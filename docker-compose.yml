version: '3.8'

services:
  # ==========================================
  # Backend API Service (NestJS)
  # ==========================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      # Target is dynamically set based on NODE_ENV (e.g., development or production)
      target: ${NODE_ENV} 
    container_name: pr-dashboard-backend
    ports:
      - '3000:3000'
    # Volumes are required for Development mode (hot reloading)
    # They persist even in Production, a known trade-off for single Compose file approach.
    volumes:
      - ./backend/src:/app/src
      - ./backend/package.json:/app/package.json
      - ./backend/package-lock.json:/app/package-lock.json
      - /app/node_modules 
      - ./backend/data:/app/data
      - ./backend/public:/app/public 
    env_file:
      - ./backend/.env
    restart: unless-stopped
    networks:
      - pr-dashboard-network

  # ==========================================
  # Frontend Service (Next.js)
  # ==========================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      # Target is dynamically set based on NODE_ENV
      target: ${NODE_ENV}
    container_name: pr-dashboard-frontend
    ports:
      - '3001:3001'
    # Volumes are required for Development mode
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - /app/node_modules
      - /app/.next
    env_file:
      - ./frontend/.env
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - pr-dashboard-network

networks:
  pr-dashboard-network:
    driver: bridge
