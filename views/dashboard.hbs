<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PR Cycle-Time Dashboard</title>
  <link rel="icon" type="image/svg+xml" href="https://zigexn.vn/images/logo.svg">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <!-- Load Chart.js first -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Load SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Load SweetAlert2 Helper -->
  <script src="/swal-helper.js"></script>
  <div class="container">
    <h1>PR Cycle-Time Dashboard</h1>
    <!-- Form để nhập PR IDs -->
    <div class="form-section">
      <form method="POST" action="/dashboard/get-data">
        <div class="form-group">
          <label for="prIds">Nhập danh sách PR IDs (cách nhau bởi dấu phẩy):</label>
          <input type="text" id="prIds" name="prIds" placeholder="Ví dụ: 1,2,3,4,5" required>
        </div>
        <button type="submit">Get Data</button>
      </form>
      <div class="raw-data-section">
        <form method="POST" action="/dashboard/raw-data" class="raw-data-form" id="rawDataForm">
          <div class="form-group">
            <label for="findyUrl">Nhập URL Findy Team:</label>
            <input 
              type="url" 
              id="findyUrl" 
              name="findyUrl" 
              placeholder="https://findy-team.io/team/analytics/cycletime?monitoring_id=12045&range=last_month" 
              required
              pattern="https://findy-team\.io/team/analytics/cycletime\?monitoring_id=\d+&range=\w+"
            >
          </div>
          <button type="submit" class="btn-raw-data">Raw Data</button>
        </form>
      </div>
    </div>

    <!-- Date selector -->
    {{#if availableDates}}
    <div class="date-selector">
      <label for="dateSelect">Chọn ngày xem dữ liệu:</label>
      <select id="dateSelect" onchange="window.location.href='/dashboard?date=' + this.value">
        <option value="">Hôm nay</option>
        {{#each availableDates}}
        <option value="{{this}}" {{#if (eq this ../selectedDate)}}selected{{/if}}>{{this}}</option>
        {{/each}}
      </select>
    </div>
    {{/if}}

    {{#if hasData}}
      <!-- Bảng dữ liệu -->
      <table>
        <thead>
          <tr>
            <th>PR Number</th>
            <th>Title</th>
            <th>Author</th>
            <th>Status</th>
            <th>Commit to Open (h)</th>
            <th>Open to Review (h)</th>
            <th>Review to Approval (h)</th>
            <th>Approval to Merge (h)</th>
            <th>Time from Open to Merge (h)</th>
            <th>Total Cycle Time (h)</th>
            <th>Workflow</th>
          </tr>
        </thead>
        <tbody>
          {{#each data}}
          <tr>
            <td><strong>#{{prNumber}}</strong></td>
            <td class="title-cell">
              <div class="title-content">
              {{#if url}}
                <a href="{{url}}" target="_blank" rel="noopener noreferrer">{{title}}</a>
              {{else}}
                {{title}}
                {{/if}}
                {{#if hasForcePushed}}
                  <span class="force-pushed-badge" title="This PR has been force-pushed">Force Pushed</span>
                {{/if}}
              </div>
              {{#if labels}}
                {{#if (gt (length labels) 0)}}
                  <div class="pr-labels">
                    {{#each labels}}
                      <span class="pr-label" style="background-color: #{{color}}; color: {{labelTextColor color}};">
                        {{name}}
                      </span>
                    {{/each}}
                  </div>
                {{/if}}
              {{/if}}
            </td>
            <td>{{author}}</td>
            <td>
              <span class="status-badge 
                {{#if (eq status 'Merged')}}status-merged{{else}}
                {{#if (eq status 'Open')}}status-open{{else}}
                {{#if (eq status 'Closed')}}status-closed{{else}}
                {{#if (eq status 'Draft')}}status-draft{{else}}
                status-unknown{{/if}}{{/if}}{{/if}}{{/if}}
              ">{{status}}</span>
            </td>
            <td>{{formatTimeWithDays commitToOpen}}</td>
            <td>{{formatTimeWithDays openToReview}}</td>
            <td>{{formatTimeWithDays reviewToApproval}}</td>
            <td>{{formatTimeWithDays approvalToMerge}}</td>
            <td><strong>{{formatTimeWithDays (add openToReview reviewToApproval approvalToMerge)}}</strong></td>
            <td><strong>{{formatTimeWithDays (add commitToOpen openToReview reviewToApproval approvalToMerge)}}</strong></td>
            <td>
              <div class="workflow-actions">
              <button class="btn-workflow" data-pr-number="{{prNumber}}" data-pr-data='{{{json this}}}' onclick="openWorkflowModalFromButton(this)">Details</button>
                {{#if needsTimelineUpdate}}
                  <button class="btn-update-timeline" data-pr-number="{{prNumber}}" onclick="updateTimeline(this)">
                    Update
                  </button>
                {{else}}
                <button class="btn-update-timeline success">
                  Updated
                </button>
                {{/if}}
                <button class="btn-delete-pr" data-pr-number="{{prNumber}}" onclick="deletePr(this)" title="Delete this PR record">
                  <span class="delete-text">Delete</span>
                </button>
              </div>
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>

      <!-- Summary Chart -->
      <div class="chart-container">
        <h2>Tổng quan Cycle Time</h2>
        <canvas id="summaryChart"></canvas>
      </div>

      <!-- Workflow Charts cho từng PR -->
      {{#each data}}
      <div class="chart-container">
        <h3>PR #{{prNumber}} - Workflow Timeline</h3>
        <canvas id="workflowChart-{{prNumber}}"></canvas>
      </div>
      {{/each}}

      <!-- Hidden data for JavaScript -->
      <!-- Debug: Data exists: {{#if data}}YES{{else}}NO{{/if}}, Length: {{length data}} -->
      <script id="chart-data" type="application/json">{{{json data}}}</script>
    {{else}}
      <div class="no-data">
        <p>Chưa có dữ liệu. Vui lòng nhập PR IDs và bấm "Get Data" để bắt đầu.</p>
      </div>
    {{/if}}
  </div>

  <!-- Load dashboard.js after Chart.js -->
  <script src="/dashboard.js"></script>

  <!-- Workflow Modal -->
  <div id="workflowModal" class="modal modal-hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">PR Workflow Details</h2>
        <span class="close" onclick="closeWorkflowModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="workflowTimeline"></div>
      </div>
    </div>
  </div>
</body>
</html>
